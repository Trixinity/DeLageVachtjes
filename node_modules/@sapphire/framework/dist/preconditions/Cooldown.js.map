{"version":3,"sources":["../../src/preconditions/Cooldown.ts"],"names":[],"mappings":";;;;AAAA,SAAS,wBAAwB;AAEjC,SAAS,mBAAmB;AAE5B,SAAS,4BAA4B;AACrC,SAAS,mBAAmB;AASrB,IAAM,mBAAN,cAA+B,qBAAqB;AAAA,EAApD;AAAA;AACN,SAAO,UAAU,oBAAI,QAA2C;AAAA;AAAA,EAEzD,WAAW,SAAkB,SAAkB,SAAmE;AACxH,UAAM,aAAa,KAAK,iBAAiB,SAAS,OAAO;AAEzD,WAAO,KAAK,UAAU,QAAQ,OAAO,IAAI,SAAS,SAAS,YAAY,SAAS;AAAA,EACjF;AAAA,EAEO,aAAa,aAAiC,SAAkB,SAAmE;AACzI,UAAM,aAAa,KAAK,qBAAqB,aAAa,OAAO;AAEjE,WAAO,KAAK,UAAU,YAAY,KAAK,IAAI,SAAS,SAAS,YAAY,YAAY;AAAA,EACtF;AAAA,EAEO,eAAe,aAAqC,SAAkB,SAAmE;AAC/I,UAAM,aAAa,KAAK,qBAAqB,aAAa,OAAO;AAEjE,WAAO,KAAK,UAAU,YAAY,KAAK,IAAI,SAAS,SAAS,YAAY,cAAc;AAAA,EACxF;AAAA,EAEQ,UACP,UACA,SACA,SACA,YACA,aAC8B;AAE9B,QAAI,QAAQ;AAAU,aAAO,KAAK,GAAG;AAGrC,QAAI,CAAC,QAAQ;AAAO,aAAO,KAAK,GAAG;AAGnC,QAAI,QAAQ,eAAe,SAAS,QAAQ;AAAG,aAAO,KAAK,GAAG;AAE9D,UAAM,YAAY,KAAK,WAAW,SAAS,OAAO,EAAE,QAAQ,UAAU;AAEtE,QAAI,UAAU,SAAS;AACtB,YAAM,YAAY,UAAU;AAE5B,aAAO,KAAK,MAAM;AAAA,QACjB,YAAY,YAAY;AAAA,QACxB,SAAS,0CAA0C,8CAA8C,IAAI;AAAA,UACpG,UAAU;AAAA,QACX,EAAE,YAAY;AAAA,QACd,SAAS,EAAE,UAAU;AAAA,MACtB,CAAC;AAAA,IACF;AAEA,cAAU,QAAQ;AAClB,WAAO,KAAK,GAAG;AAAA,EAChB;AAAA,EAEQ,iBAAiB,SAAkB,SAAsC;AAChF,YAAQ,QAAQ,OAAO;AAAA,MACtB,KAAK,YAAY;AAChB,eAAO;AAAA,MACR,KAAK,YAAY;AAChB,eAAO,QAAQ,QAAQ;AAAA,MACxB,KAAK,YAAY;AAChB,eAAO,QAAQ,OAAO,MAAM,QAAQ,QAAQ;AAAA,MAC7C;AACC,eAAO,QAAQ,OAAO;AAAA,IACxB;AAAA,EACD;AAAA,EAEQ,qBAAqB,aAAqC,SAAsC;AACvG,YAAQ,QAAQ,OAAO;AAAA,MACtB,KAAK,YAAY;AAChB,eAAO;AAAA,MACR,KAAK,YAAY;AAChB,eAAO,YAAY;AAAA,MACpB,KAAK,YAAY;AAChB,eAAO,YAAY,WAAW,YAAY;AAAA,MAC3C;AACC,eAAO,YAAY,KAAK;AAAA,IAC1B;AAAA,EACD;AAAA,EAEQ,WAAW,SAAkB,SAAsC;AAC1E,QAAI,UAAU,KAAK,QAAQ,IAAI,OAAO;AACtC,QAAI,CAAC,SAAS;AACb,gBAAU,IAAI,iBAAiB,QAAQ,OAAO,QAAQ,KAAK;AAC3D,WAAK,QAAQ,IAAI,SAAS,OAAO;AAAA,IAClC;AACA,WAAO;AAAA,EACR;AACD;AAzFa","sourcesContent":["import { RateLimitManager } from '@sapphire/ratelimits';\nimport type { BaseCommandInteraction, CommandInteraction, ContextMenuInteraction, Message, Snowflake } from 'discord.js';\nimport { Identifiers } from '../lib/errors/Identifiers';\nimport type { Command } from '../lib/structures/Command';\nimport { AllFlowsPrecondition } from '../lib/structures/Precondition';\nimport { BucketScope } from '../lib/types/Enums';\n\nexport interface CooldownPreconditionContext extends AllFlowsPrecondition.Context {\n\tscope?: BucketScope;\n\tdelay: number;\n\tlimit?: number;\n\tfilteredUsers?: Snowflake[];\n}\n\nexport class CorePrecondition extends AllFlowsPrecondition {\n\tpublic buckets = new WeakMap<Command, RateLimitManager<string>>();\n\n\tpublic messageRun(message: Message, command: Command, context: CooldownPreconditionContext): AllFlowsPrecondition.Result {\n\t\tconst cooldownId = this.getIdFromMessage(message, context);\n\n\t\treturn this.sharedRun(message.author.id, command, context, cooldownId, 'message');\n\t}\n\n\tpublic chatInputRun(interaction: CommandInteraction, command: Command, context: CooldownPreconditionContext): AllFlowsPrecondition.Result {\n\t\tconst cooldownId = this.getIdFromInteraction(interaction, context);\n\n\t\treturn this.sharedRun(interaction.user.id, command, context, cooldownId, 'chat input');\n\t}\n\n\tpublic contextMenuRun(interaction: ContextMenuInteraction, command: Command, context: CooldownPreconditionContext): AllFlowsPrecondition.Result {\n\t\tconst cooldownId = this.getIdFromInteraction(interaction, context);\n\n\t\treturn this.sharedRun(interaction.user.id, command, context, cooldownId, 'context menu');\n\t}\n\n\tprivate sharedRun(\n\t\tauthorId: string,\n\t\tcommand: Command,\n\t\tcontext: CooldownPreconditionContext,\n\t\tcooldownId: string,\n\t\tcommandType: string\n\t): AllFlowsPrecondition.Result {\n\t\t// If the command it is testing for is not this one, return ok:\n\t\tif (context.external) return this.ok();\n\n\t\t// If there is no delay (undefined, null, 0), return ok:\n\t\tif (!context.delay) return this.ok();\n\n\t\t// If the user has provided any filtered users and the authorId is in that array, return ok:\n\t\tif (context.filteredUsers?.includes(authorId)) return this.ok();\n\n\t\tconst ratelimit = this.getManager(command, context).acquire(cooldownId);\n\n\t\tif (ratelimit.limited) {\n\t\t\tconst remaining = ratelimit.remainingTime;\n\n\t\t\treturn this.error({\n\t\t\t\tidentifier: Identifiers.PreconditionCooldown,\n\t\t\t\tmessage: `There is a cooldown in effect for this ${commandType} command. It'll be available at ${new Date(\n\t\t\t\t\tratelimit.expires\n\t\t\t\t).toISOString()}.`,\n\t\t\t\tcontext: { remaining }\n\t\t\t});\n\t\t}\n\n\t\tratelimit.consume();\n\t\treturn this.ok();\n\t}\n\n\tprivate getIdFromMessage(message: Message, context: CooldownPreconditionContext) {\n\t\tswitch (context.scope) {\n\t\t\tcase BucketScope.Global:\n\t\t\t\treturn 'global';\n\t\t\tcase BucketScope.Channel:\n\t\t\t\treturn message.channel.id;\n\t\t\tcase BucketScope.Guild:\n\t\t\t\treturn message.guild?.id ?? message.channel.id;\n\t\t\tdefault:\n\t\t\t\treturn message.author.id;\n\t\t}\n\t}\n\n\tprivate getIdFromInteraction(interaction: BaseCommandInteraction, context: CooldownPreconditionContext) {\n\t\tswitch (context.scope) {\n\t\t\tcase BucketScope.Global:\n\t\t\t\treturn 'global';\n\t\t\tcase BucketScope.Channel:\n\t\t\t\treturn interaction.channelId;\n\t\t\tcase BucketScope.Guild:\n\t\t\t\treturn interaction.guildId ?? interaction.channelId;\n\t\t\tdefault:\n\t\t\t\treturn interaction.user.id;\n\t\t}\n\t}\n\n\tprivate getManager(command: Command, context: CooldownPreconditionContext) {\n\t\tlet manager = this.buckets.get(command);\n\t\tif (!manager) {\n\t\t\tmanager = new RateLimitManager(context.delay, context.limit);\n\t\t\tthis.buckets.set(command, manager);\n\t\t}\n\t\treturn manager;\n\t}\n}\n"]}